<!doctype html>
<html lang="en-GB">
<head>
    <title>Slots in HTML template - Unit test samples in visual presentation</title>
    <meta charset="utf-8">
    <script src="slots-light-vs-shadow.js" type="module"></script>
    <script type="module" src="https://unpkg.com/html-demo-element@1/html-demo-element.js"></script>
    <style>
        body { display: flex; flex-wrap: wrap; gap: 1rem; }
        body>*{flex: auto;}
        [slot="description"] {
            margin: 0;
            padding: 0 1rem 1rem 1rem;
        }
        #host {
            border: 1px dashed green;
            margin: 0.5rem;
        }
        .shadow,.light{ border: 2px dashed blue; margin: .5rem;}
        .light { border-color:green;}
    </style>
</head>
<body>
    <section>
        <header>
            <h1>Visual presentation of Slot in shadow DOM from unit test </h1>
            <a href="demo.html"> Demo home</a>
            | <a href="PokeApi-Explorer.html"> List from data </a>
        </header>

    Only first level slots in template are substituted from web component content HTML.<br/>
    The embedded slots like "inner-X" in sample template are ignored by shadowDOM.<br/>
    Outline
        <span class="shadow">shadow DOM blue </span>,
        <span class="light" >light  DOM green</span>. They should be rendered same.

</section>


<html-demo-element legend="1. Basics">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/main/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L8"
       > Slots: Basic. Basic, elements only. </a>
    </h3>
    <template>
        <div id="test_basic" slot="text">
            <div id="host">
                <template data-mode="open">
                    before slot
                    <slot id="s1" name="slot1">slot s1</slot>
                    after slot
                </template>
                <div id="c1" slot="slot1">slot1 override</div>
            </div>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="2. Slots: Slots in closed">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L33"
       > Slots in closed; Slots in closed, elements only </a>
    </h3>
    <template>
        <div id="test_basic_closed">
            <div id="host">
                <template data-mode="closed">
                    before slot
                    <slot id="s1" name="slot1">slot s1</slot>
                    after slot
                </template>
                <div id="c1" slot="slot1">slot1 override</div>
            </div>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="3. Slots: Slots not in a shadow tree">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L58"
       > Slots not in a shadow tree, ... elements only </a>
    </h3>
    <template>
        <div id="test_slot_not_in_shadow">
            <slot id="s1"></slot>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="4. Slots: Distributed nodes for Slots not in a shadow tree.">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L77"
       > assignedSlot, assignedNodes(), assignedNodes({ flatten: true }) </a>
    </h3>
    <template>
        <div id="test_slot_not_in_shadow_2">
            <slot id="s1">
                <div id="c1"></div>
            </slot>
            <slot id="s2">
                <div id="c2"></div>
                <slot id="s3">
                    <div id="c3_1"></div>
                    <div id="c3_2"></div>
                </slot>
            </slot>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="5. Slots: Name matching">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L110"
       > assignedSlot </a>
    </h3>
    <template>
        <div id="test_slot_name_matching">
            <div id="host">
                <template data-mode="open">
                    <slot id="s1" name="slot1"></slot>
                    <slot id="s2" name="slot2"></slot>
                    <slot id="s3" name="xxx"></slot>
                </template>
                <div id="c1" slot="slot1">#c1</div>
                <div id="c2" slot="slot2">#c2</div>
                <div id="c3" slot="yyy"  >#c3</div>
            </div>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="6. Slots: No direct host child">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L134"
       > assignedSlot </a>
    </h3>
    <template>
        <div id="test_no_direct_host_child">
            <div id="host">
                <template data-mode="open">
                    <slot id="s1" name="slot1">#s1</slot>
                    <slot id="s2" name="slot1">#s2</slot>
                </template>
                <div id="c1" slot="slot1">#c1</div>
                <div id="c2" slot="slot1">#c2</div>
                <div>
                    <div id="c3" slot="slot1">#c3</div>
                </div>
            </div>
        </div>
    </template>
</html-demo-element>

<html-demo-element legend="7. Slots: Default Slot">
    <h3 slot="description"><a
        href="https://github.com/chromium/chromium/blob/7c6820016905bc3c7fee8a7b58e41694bdfcbef1/third_party/blink/web_tests/external/wpt/shadow-dom/slots.html#L161"
       > assignedSlot </a>
    </h3>
    <template>
        <div id="test_default_slot">
            <div id="host">
                <template data-mode="open">
                    <slot id="s1" name="slot1">#s1</slot>
                    <slot id="s2">#s2</slot>
                    <slot id="s3">#s3</slot>
                </template>
                <div id="c1">#c1</div>
                <div id="c2" slot="">#c2</div>
                <div id="c3" slot="foo">#c3</div>
            </div>
        </div>
    </template>
</html-demo-element>


<html-demo-element src="slots-light-vs-shadow.js" legend="slots-light-vs-shadow.js"></html-demo-element>

<script src="./slots-light-vs-shadow.js" type="module"></script>
<script type="module">
    import { expect } from "@open-wc/testing";
    import { runTests } from "@web/test-runner-mocha";
    import { createTestTree, removeWhiteSpaceOnlyTextNodes } from './slots-light-vs-shadow.js';
    import $ from './CssChain.js';

    const test = ( cb, title )=>{ it(title, cb); }
    ,   assert_equals = (a,b)=>expect(a).to.equal(b)
    ,   assert_array_equals = (a,b)=>expect(a).to.eql(b);

    runTests(async () => {
        describe("test_basic", () => {

            test(() => {
                let n = createTestTree(test_basic);
                removeWhiteSpaceOnlyTextNodes(n.test_basic);

                assert_equals(n.c1.assignedSlot, n.s1);
                assert_array_equals(n.s1.assignedNodes(), [n.c1]);
            }, 'Slots: Basic.');
            test(() => {
                let n = createTestTree(test_basic);

                assert_array_equals(n.s1.assignedElements(), [n.c1]);
            }, 'Slots: Basic, elements only.');
            it('createTestTree$: Basic', async () => {

                const lightText  = $($(test_basic).parent().$('.light  #host')[0]        ).text().replace( /\s+/g ,' ').trim();
                const shadowText = $($(test_basic).parent().$('.shadow #host').shadowRoot).text().replace( /\s+/g ,' ').trim();

                expect(lightText).to.equal(shadowText);
                expect(lightText).to.equal('before slot slot1 override after slot');
            });
            test(() => {
                let n = createTestTree(test_basic_closed);
                removeWhiteSpaceOnlyTextNodes(n.test_basic_closed);

                assert_equals(n.c1.assignedSlot, null);
                assert_array_equals(n.s1.assignedNodes(), [n.c1]);
            }, 'Slots: Slots in closed.');
            test(() => {
                let n = createTestTree(test_basic_closed);
                assert_array_equals(n.s1.assignedElements(), [n.c1]);
            }, 'Slots: Slots in closed, elements only.');
            it('createTestTree$: Slots in closed', async () => {

                expect($(test_basic_closed).parent().$('.shadow #host').shadowRoot).to.equal(null);// closed shadow mode makes shadowRoot not available by JS
                const lightText  = $($(test_basic_closed).parent().$('.light  #host')[0]        ).text().replace( /\s+/g ,' ').trim();
                expect(lightText).to.equal('before slot slot1 override after slot');
            });
            test(() => {
                let n = createTestTree(test_slot_not_in_shadow);
                removeWhiteSpaceOnlyTextNodes(n.test_slot_not_in_shadow);

                assert_array_equals(n.s1.assignedNodes(), []);
            }, 'Slots: Slots not in a shadow tree.');
            test(() => {
                let n = createTestTree(test_slot_not_in_shadow);

                assert_array_equals(n.s1.assignedElements(), []);
            }, 'Slots: Slots not in a shadow tree, elements only.');
            it('createTestTree$: Slots not in a shadow tree', ()=>
            {
                const slotLight  = $(test_slot_not_in_shadow).parent().$('.light' ).slot();
                const slotShadow = $(test_slot_not_in_shadow).parent().$('.shadow').slot();
                expect(slotLight .assignedNodes   ().length).to.equal(0);
                expect(slotShadow.assignedNodes   ().length).to.equal(0);
                expect(slotLight .assignedElements().length).to.equal(0);
                expect(slotShadow.assignedElements().length).to.equal(0);
            });
            test(() => {
                let n = createTestTree(test_slot_not_in_shadow_2);
                removeWhiteSpaceOnlyTextNodes(n.test_slot_not_in_shadow_2);

                assert_equals(n.c1.assignedSlot, null);
                assert_equals(n.c2.assignedSlot, null);
                assert_equals(n.c3_1.assignedSlot, null);
                assert_equals(n.c3_2.assignedSlot, null);

                assert_array_equals(n.s1.assignedNodes(), []);
                assert_array_equals(n.s2.assignedNodes(), []);
                assert_array_equals(n.s3.assignedNodes(), []);

                assert_array_equals(n.s1.assignedNodes({ flatten: true }), []);
                assert_array_equals(n.s2.assignedNodes({ flatten: true }), []);
                assert_array_equals(n.s3.assignedNodes({ flatten: true }), []);
            }, 'Slots: Distributed nodes for Slots not in a shadow tree.');
            it('createTestTree$: Distributed nodes for Slots not in a shadow tree.', ()=>
            {
                const shadow = $(test_slot_not_in_shadow_2).parent().$('.shadow');
                const light  = $(test_slot_not_in_shadow_2).parent().$('.light' );

                expect(shadow.$('#c1'  ).assignedSlot).to.equal(null);
                expect(light .$('#c1'  ).assignedSlot).to.equal(null);
                expect(shadow.$('#c3_1').assignedSlot).to.equal(null);
                expect(light .$('#c3_1').assignedSlot).to.equal(null);
                expect(shadow.$('#c3_2').assignedSlot).to.equal(null);
                expect(light .$('#c3_2').assignedSlot).to.equal(null);

                expect(shadow.$('#s1').assignedNodes().length).to.equal(0);
                expect(light .$('#s1').assignedNodes().length).to.equal(0);
                expect(shadow.$('#s2').assignedNodes().length).to.equal(0);
                expect(light .$('#s2').assignedNodes().length).to.equal(0);
                expect(shadow.$('#s3').assignedNodes().length).to.equal(0);
                expect(light .$('#s3').assignedNodes().length).to.equal(0);

                expect(shadow.$('#s1').assignedNodes({ flatten: true }).length).to.equal(0);
                expect(light .$('#s1').assignedNodes({ flatten: true }).length).to.equal(0);
                expect(shadow.$('#s2').assignedNodes({ flatten: true }).length).to.equal(0);
                expect(light .$('#s2').assignedNodes({ flatten: true }).length).to.equal(0);
                expect(shadow.$('#s3').assignedNodes({ flatten: true }).length).to.equal(0);
                expect(light .$('#s3').assignedNodes({ flatten: true }).length).to.equal(0);
            });
            test(() => {
                let n = createTestTree(test_slot_name_matching);
                removeWhiteSpaceOnlyTextNodes(n.test_slot_name_matching);

                assert_equals(n.c1.assignedSlot, n.s1);
                assert_equals(n.c2.assignedSlot, n.s2);
                assert_equals(n.c3.assignedSlot, null);
            }, 'Slots: Name matching');
            it('createTestTree$: Name matching', ()=>
            {
                const shadow = $(test_slot_name_matching).parent().$('.shadow');
                const light  = $(test_slot_name_matching).parent().$('.light' );
                expect(shadow.$('#c1').assignedSlot).to.equal(shadow.$('#host').slot('slot1')[0]);

                // assignedSlot in light DOM is not working, testing content instead
                // expect(light .$('#c1').assignedSlot).to.equal(light .$('#host').slot('slot1')[0]);
                expect( light.$('#host').slot('slot1').text() ).to.equal( '#c1' );
                expect( light.$('#s1').text() ).to.equal( '#c1' );

                expect(shadow.$('#c2').assignedSlot).to.equal(shadow.$('#host').slot('slot2')[0]);
                expect( light.$('#host').slot('slot2').text() ).to.equal( '#c2' );
                expect( light.$('#s2').text() ).to.equal( '#c2' );

                expect(shadow.$('#c3').assignedSlot).to.equal(null);
                expect( light.$('#host').slot('xxx').text() ).to.equal( '' );
                expect( light.$('#s3').text() ).to.equal( '' );
            });
            test(() => {
                let n = createTestTree(test_no_direct_host_child);
                removeWhiteSpaceOnlyTextNodes(n.test_no_direct_host_child);

                assert_equals(n.c1.assignedSlot, n.s1);
                assert_equals(n.c2.assignedSlot, n.s1);
                assert_equals(n.c3.assignedSlot, null);

                assert_array_equals(n.s1.assignedNodes(), [n.c1, n.c2]);
            }, 'Slots: No direct host child.');
            it('6 createTestTree$: No direct host child', ()=>
            {
                const shadow = $(test_no_direct_host_child).parent().$('.shadow');
                const light  = $(test_no_direct_host_child).parent().$('.light' );
                expect(shadow.$('#c1').assignedSlot).to.equal(shadow.$('#host').slot('slot1')[0]);

                // assignedSlot in light DOM is not working, testing content instead
                // expect(light .$('#c1').assignedSlot).to.equal(light .$('#host').slot('slot1')[0]);
                expect( shadow.$('#host').slot('slot1').text() ).to.equal( '#c1#c2#s2' );
                expect(  light.$('#host').slot('slot1').text() ).to.equal( '#c1#c2#s2' );
            });
            test(() => {
                let n = createTestTree(test_default_slot);
                removeWhiteSpaceOnlyTextNodes(n.test_default_slot);

                assert_equals(n.c1.assignedSlot, n.s2);
                assert_equals(n.c2.assignedSlot, n.s2);
                assert_equals(n.c3.assignedSlot, null);
            }, 'Slots: Default Slot.');
            it('7 createTestTree$: Default Slot', ()=>
            {
                const shadow = $(test_default_slot).parent().$('.shadow');
                const light  = $(test_default_slot).parent().$('.light' );
                expect(shadow.$('#c1').assignedSlot).to.equal(shadow.$('#host').slot('')[0]);
                expect(shadow.$('#c2').assignedSlot).to.equal(shadow.$('#host').slot('')[0]);
                expect(shadow.$('#c3').assignedSlot).to.equal(null);

                // assignedSlot in light DOM is not working, testing content instead
                // expect(light .$('#c1').assignedSlot).to.equal(light .$('#host').slot('slot1')[0]);
                expect( shadow.$('#host').slot().text().replace( /\s+/g , '') ).to.equal( '#s1#c1#c2#s3' );
                expect(  light.$('#host').slot().text().replace( /\s+/g , '') ).to.equal( '#s1#c1#c2#s3' );
            });
        });
    });


</script>
</body>
</html>
